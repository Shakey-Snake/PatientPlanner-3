@page
@model IndexModel

@{
    ViewData["Title"] = "Timetable";
}

<script language="JavaScript" type="text/javascript" src="~/js/HidePage.js?n=4"></script>
<script language="JavaScript" type="text/javascript" src="~/js/CreateDevice.js?n=5"></script>
<script language="JavaScript" type="text/javascript" src="~/js/site.js?n=5"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

@Html.AntiForgeryToken()

<input id="PushEndpoint" name="PushEndpoint" readonly required hidden />
<input class="PushP256DH" name="PushP256DH" readonly required hidden />
<input id="PushAuth" name="PushAuth" readonly required hidden />

<div class="reminders">
    <div id="no-support" class="critical-warning" style="display: none;">
        <p>It looks like your browser doesn't support notifications, please use a different browser to enable
            notifications</p>
    </div>

    <div id="notifications-denied" class="critical-warning" style="display: none;">
        <p id="notifications-denied-text" class="reminder-body">It looks like you have notifications blocked, please
            enable the notifications in page info next to the URL</p>
    </div>

    <div id="browser-notification-reminder" class="warning" style="display: none;">
        <label for="browser-notifications-enable" class="reminder-body">You have notifications disabled for the browser,
            please click here to enable notifications</label>
        <button id="browser-notifications-enable" class="btn btn-primary" onclick="enableBrowserNotifications()">Enable
            Notifications</button>
    </div>

    <div id="site-notifications-reminder" class="warning" style="display: none;">
        <label for="site-notifications-enable" class="reminder-body">You have notifications disabled, please enable them
            in the Shift and Task Settings on
            the Patients Page or click here to enable notifications</label>
        <button id="site-notifications-enable" class="btn btn-primary" onclick="enableSiteNotifications()">Enable
            Notifications</button>
    </div>

    <div id="session-warning" class="warning" style="display: none;">
        <label for="site-session-reminder" class="reminder-body">Your session is about to time-out, please click here to
            refresh the session</label>
        <button id="site-session-reminder" class="btn btn-primary" onclick="refreshPage()">Refresh</button>
    </div>

    <div id="session-timeout" class="critical-warning" style="display: none;">
        <label for="site-session-reminder" class="reminder-body">Your session has timed-out, please click here to
            refresh to save future changes</label>
        <button id="site-session-reminder" class="btn btn-primary" onclick="refreshPage()">Refresh</button>
    </div>
</div>

<div class="text-center">
    <h1 class="display-4">Timetable</h1>
</div>

@if (Model.times.Count > 0)
{
    <div style="display: block; overflow-x: auto; white-space: nowrap;">
        <table class="table time-table">
            <thead>
                <tr>
                    <th class="title">Time</th>
                    @foreach (var item in Model.Patients)
                    {
                        <th class="title">
                            @Html.DisplayFor(modelItem => item.RoomNumber)
                        </th>
                    }
                </tr>
            </thead>
            @* cant use overflow-x, possibly change other elements to match? *@
            @* seems like div is messing with the stickiness no matter what. sticky works when there is *@
            <tbody>
                @* Loop over the time period *@
                @foreach (var time in Model.times)
                {
                    <tr id="@time">
                        <td>
                            @Html.DisplayFor(modelItem => time)
                        </td>
                        @* Loop over the patients *@
                        @foreach (var item in Model.Patients)
                        {
                            <td>
                                @* Gets the list of tasks for the patient for the specific time period *@
                                @{
                                    var taskList = Model.taskList.Where(t => t.DueTime == time && t.PatientID == item.PatientID);
                                }

                                @foreach (var task in taskList)
                                {
                                    <div taskid="@(task.PatientDisplayTaskID)" completed="@(task.Completed.ToString())"
                                        style="width: fit-content; padding: 5px;">
                                        <div class=" color-square" style='background-color: @(task.TaskColour)'>
                                    </div>
                                    <p style='display: inline-block; margin: 0px;'>@Html.DisplayFor(modelItem => task.TaskName)</p>
                </div>
                                }
            </td>
                        }
        </tr>
                }

    </tbody>
    </table>
    </div>

}

<script>
    timeLineTimer();
    taskReminderTimer();
    $(document).ready(function () {
        //start the timer for the session timeout
        initSessionMonitor();
    });
    // highlight the tasks the user will be notfied of
    // get the task list via a ajax request
</script>